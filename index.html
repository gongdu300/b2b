<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>SmartInventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- 공통 레이아웃/스타일 -->
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* 보조 스타일 */
    .tab-hidden { display: none; }
    .header-controls { display:flex; gap:.5rem; align-items:center; }
    .date-selector { padding:.5rem 1rem; background:var(--card-bg); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary); }
    .nav-item.active { background:rgba(37,99,235,0.2); color:var(--primary-color); }


    /* ✅ 미리보기 표: 드래그 스크롤 */
    #previewTableWrapper{
      overflow: auto;       /* 가로 스크롤 가능 */
      cursor: grab;         /* 손 아이콘 */
    }
    #previewTableWrapper.dragging{
      cursor: grabbing;
      user-select: none;    /* 드래그 중 텍스트 선택 방지 */
    }
    /* (선택) 셀 줄바꿈 방지로 가로폭 유지 */
    #previewTable{ white-space: nowrap; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <div class="logo-icon">SI</div>
      <div class="logo-text">SmartInventory</div>
    </div>
  </header>

  <!-- Layout -->
  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="nav-section">
        <div class="nav-title">Navigation</div>
        <div class="nav-item active" id="nav-prep">🧰 데이터 전처리</div>
        <div class="nav-item" id="nav-forecast">📈 수요예측</div>
        <div class="nav-item" id="nav-inventory">📦 재고관리</div>
      </div>
    </aside>

    <!-- Main -->
    <section class="main-content">
      <section id="prep-section">
        <!-- ========= 업로더 섹션 ========= -->
        <section id="uploader-section" style="margin-bottom:18px;">
          <h2 style="margin-bottom:1rem;">📤 데이터 업로드</h2>

          <!-- Health -->
          <!-- 그냥 display:none으로 감추기 -->
          <div class="dl-row" style="display:none;">
            <button class="pp-btn" id="up-btnHealth">서버 상태 확인</button>
            <div class="dl-stats" id="up-healthText">engine: ? · startup_ok: ?</div>
          </div>
          <div class="table-scroll" style="display:none; margin-bottom:1rem;">
            <pre id="up-healthOut" style="padding:1rem; margin:0; background:transparent;"></pre>
          </div>

          <!-- Upload -->
          <div class="dl-row">
            <label class="file-uploader" style="margin-bottom:15px;">
              <input type="file" id="up-fileInput" accept=".csv" />
              CSV 선택
            </label>
            <span id="up-fileNameLabel" class="dl-stats" style="min-width:200px;"></span>
            <button class="pp-btn primary" id="up-btnUpload">DB 저장</button>
            <div class="dl-stats" id="up-uploadNote"></div>
          </div>

          <!-- 업로드 진행도 -->
          <div id="up-progress" style="display:none; margin-top:6px;">
            <div id="up-progress-bar"
                style="height:6px; width:0; background:#2563eb; border-radius:4px; transition:width .25s;"></div>
            <div id="up-progress-text"
                style="margin-top:4px; font-size:12px; opacity:.75;">업로드 준비중...</div>
          </div>

          <!-- ✅ 헤더 변환/경고 출력 위치 -->
          <div id="up-translateOut"></div>


          <!-- ✅ 업로드 응답 JSON 표시용 (숨김 가능) -->
          <div class="table-scroll" style="display:none; margin-bottom:1rem;">
            <pre id="up-uploadOut" style="padding:1rem; margin:0; background:transparent;"></pre>
          </div>


          <!-- Stats (드롭다운 + 새로고침) -->
          <div class="dl-row">
            <div class="dl-group">
              <label>테이블 선택</label>
              <select id="up-tableSelect" style="min-width:260px;">
                <option value="">(불러오는 중...)</option>
              </select>
              <!-- ✅ 새로 추가: 테이블 미리보기 + CSV 다운로드 버튼 -->
              <div class="dl-toolbar"  style="margin-bottom:15px;">
                <button id="btnPreviewTable" class="pp-btn">테이블 미리보기</button>
                <button id="btnDownloadTable" class="pp-btn">CSV 다운로드</button>
              </div>
            </div>
            <!-- <button class="pp-btn" id="up-btnStats">POST /stats</button> -->
          </div>

          <!-- Stats 결과
          <div class="table-scroll" style="margin-bottom:1rem; display:none;">
            <pre id="up-statsOut" style="padding:1rem; margin:0; background:transparent;"></pre>
          </div>


          <!-- Debug -->
          <div class="dl-row"  style="display: none;">
            <button class="pp-btn" id="up-btnUploads">GET /_debug/uploads</button>
            <details style="margin-left:auto;">
              <summary>원본 JSON 보기</summary>
              <pre id="up-debugJson" style="padding:1rem; margin:0; background:transparent;"></pre>
            </details>
          </div>

          <div class="table-scroll">
            <table id="up-uploadsTable" class="dl-table">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- 번역 확인 모달 -->
          <div id="translateConfirm" style="display:none;position:fixed;inset:0;z-index:9999;
            background:rgba(0,0,0,.45);align-items:center;justify-content:center;">
            <div style="width:min(680px,92vw);max-height:80vh;overflow:auto;
              background:var(--card-bg,#0b1220);border:1px solid var(--border-color,#334155);
              border-radius:12px; padding:16px;">
              <div id="tc-tableName" style="margin-bottom:8px;font-weight:700;"></div>
              <div id="tc-body"></div>
              <div style="display:flex;justify-content:flex-end;margin-top:12px;">
                <button id="tc-ok" class="pp-btn">확인</button>
              </div>
            </div>
          </div>

        </section>


        <!-- ========= 데이터 랩 섹션 ========= -->
        <section id="data-lab" style="margin-bottom:18px;">
          <div class="chart-header">
            <h2 class="chart-title">🧪 데이터 랩</h2>
            <div class="chart-controls">
              <button id="downloadProcessed" class="chart-btn" disabled>처리된 CSV 다운로드</button>
            </div>
          </div>

          <!-- 데이터 요약 -->
          <div id="dataSummary" class="data-summary" style="display:none;"></div>

          <!-- Top: Preview Controls & Stats -->
          <div id="preview-controls" class="dl-row">
            <div class="dl-group">
              <label>미리보기 행 최대 (max rows)</label>
              <input id="maxRows" type="number" min="1" value="100" max="100" />
            </div>
            <div class="dl-group">
              <label>미리보기 컬럼 최대 (max cols)</label>
              <input id="maxCols" type="number" min="1" value="1" />
            </div>
            <button id="applyPreview" class="chart-btn">미리보기 적용</button>
            <div class="dl-stats" id="dataStats">총 0 rows x 0 cols</div>
          </div>
          <div class="save-actions" style="display:flex; gap:.5rem; align-items:center; margin-top:.75rem; margin-bottom:15px;">
            <button id="btnCreateNew" class="pp-btn">📄 새 테이블 만들기</button>
            <span id="saveNote" style="opacity:.75;" class="muted"></span>
          </div>
          
          <!-- Middle: Preview Table -->
          <!-- 미리보기 테이블 -->
          <div id="previewTableWrapper" class="table-scroll">
            <table id="previewTable" class="dl-table">
              <thead></thead>
              <tbody></tbody>
            </table>
            <div id="emptyState" class="dl-empty">표시할 데이터가 없습니다</div>
          </div>

          <!-- Bottom: Preprocessing Buttons -->
          <div class="dl-toolbar">
            <button class="pp-btn" data-tool="fileInfo">ℹ️ 파일 상세정보</button>
            <button class="pp-btn" data-tool="dropCols">🧹 컬럼 삭제</button>
            <button class="pp-btn" data-tool="renameCol">✏️ 컬럼 이름 변경</button>
            <button class="pp-btn" data-tool="filterRows">🔍 행 필터</button>
            <button class="pp-btn" data-tool="fillNa">🩹 결측치 채우기</button>
            <button class="pp-btn" data-tool="outliers">📈 이상치 처리</button>
            <button class="pp-btn" data-tool="sortBy">↕️ 정렬</button>
            <!-- <button class="pp-btn primary" id="btnTrain">🧠 학습</button> -->
          </div>

          <!-- Dynamic Tool Forms -->
          <div id="toolFormArea" class="dl-form-area"></div>
        </section>
      </section>

      <!-- ✅ 수요예측: 상단 필터 + 테이블 + 하단 추이 -->
      <section id="forecast-section" style="display:none;">
        
        <!-- 하단: 추이 차트 카드 -->
        <div class="df-panel">
          <div class="df-header">
            <div class="df-title">수요 예측</div>
            <div class="df-actions" style="gap:.5rem; align-items:center;">
              <!-- ✅ 학습 후 채울 제품코드 셀렉트 -->
              <select id="forecast-product-select" class="df-input" style="min-width:150px; display:none;">
                <option value="">(제품코드 선택)</option>
              </select>
              <button class="pp-btn primary" id="btnTrain">🧠 학습</button>
            </div>
          </div>
          <div class="df-chart-placeholder" aria-label="라인 차트 자리">
            <!-- 차트 라이브러리 붙일 때 canvas/svg 삽입 -->
            <canvas id="forecastChart" style="width:100%; height:260px;"></canvas>
          </div>
        </div>
      </section>

      <!-- ✅ 재고 요약 설정 버튼 -->
      <section id="inventory-section" style="display:none;">
        <div class="chart-header">
          <h2>📦 재고 요약</h2>
          <button id="btnInventorySummary" class="pp-btn primary">재고 요약 실행</button>
        </div>

        <!-- ✅ 모든 차트가 하나의 영역에 렌더링됨 -->
        <div id="inventoryChartsArea"
            style="
              display:grid;
              grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
              gap:1rem;
              margin-top:1rem;
              padding-right:.5rem; padding-bottom:.5rem;  /* 스크롤바 겹침 방지 */
              box-sizing:border-box;
            ">
        </div>


        <!-- ✅ 단일 모달 (두 함수가 공용으로 씀) -->
        <div id="inventoryModal" style="display:none;position:fixed;inset:0;z-index:9999;
          background:rgba(0,0,0,.45);align-items:center;justify-content:center;">
          <div style="width:min(600px,90vw);background:#fff;border-radius:12px;padding:20px;">
            <h3 style="margin-bottom:10px;">재고 요약 설정</h3>

            <div style="margin-bottom:10px;">
              <label>테이블 선택:</label>
              <select id="inv-tableSelect" style="width:100%;"></select>
            </div>

            <div style="margin-bottom:10px;">
              <label>제품코드 컬럼:</label>
              <select id="inv-productColSel" style="width:100%;"></select>
            </div>

            <div style="margin-bottom:10px;">
              <label>창고 컬럼:</label>
              <select id="inv-warehouseColSel" style="width:100%;"></select>
            </div>

            <div style="margin-bottom:10px;">
              <label>재고수량 컬럼(다중선택):</label>
              <select id="inv-qtyColSel" style="width:100%;" multiple size="5"></select>
            </div>

            <div style="text-align:right;">
              <button id="inv-btnConfirm" class="pp-btn primary">확인</button>
              <button id="inv-btnCancel" class="pp-btn">취소</button>
            </div>
          </div>
        </div>
      </section>
    </section>
  </div>

  <!-- === 수요예측: 학습 모달 === -->
  <div id="trainModal"
      style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;">
    <div style="width:430px; background:#fff; border-radius:14px; padding:18px 20px;">
      <h3 style="margin-top:0; display:flex; gap:6px; align-items:center;">🧠 학습 설정</h3>

      <!-- 테이블 -->
      <label style="font-size:13px;">테이블 선택</label>
      <select id="train-table-select" class="df-input" style="width:100%; margin-bottom:10px;">
        <option value="">(테이블 선택)</option>
      </select>

      <!-- 타깃 컬럼 -->
      <label style="font-size:13px;">타깃 컬럼 (다중선택)</label>
      <select id="train-target-cols" multiple size="6" class="df-input" style="width:100%; margin-bottom:10px;"></select>

      <!-- ✅ 기준일(T일) 컬럼 -->
      <label style="font-size:13px;">기준일 컬럼</label>
      <select id="train-time-col" class="df-input" style="width:100%; margin-bottom:10px;">
        <option value="">(날짜/일자 컬럼 선택)</option>
      </select>

      <!-- ✅ 제품코드 컬럼 -->
      <label style="font-size:13px;">제품코드 컬럼</label>
      <select id="train-product-col" class="df-input" style="width:100%; margin-bottom:10px;">
        <option value="">(제품/품번 컬럼 선택)</option>
      </select>

      <!-- 예측 기간 -->
      <label style="font-size:13px;">예측 기간 (시계열일 때)</label>
      <input id="train-horizon" type="number" value="14" min="1" class="df-input"
            style="width:100%; margin-bottom:14px;" />

      <div style="display:flex; justify-content:flex-end; gap:.5rem;">
        <button id="train-close" class="pp-btn">닫기</button>
        <button id="train-start" class="pp-btn primary">학습 시작</button>
      </div>
    </div>
    <!-- === 재고관리: 설정 모달 === -->
    <div id="invModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.4); z-index:9999;">
      <div style="width:min(520px,90vw); background:#fff; border-radius:12px; padding:18px 20px; max-height:90vh; overflow:auto;">
        <h3 style="margin-top:0;">📦 재고 요약 설정</h3>

        <!-- 1) 테이블 선택 -->
        <label style="display:block; margin-top:8px; font-weight:600;">테이블 선택</label>
        <select id="invm-table" style="width:100%; padding:6px 8px; margin-top:4px; margin-bottom:12px;">
          <option value="">(테이블 선택)</option>
        </select>

        <!-- 2) 컬럼 선택 -->
        <label style="display:block; margin-top:8px; font-weight:600;">창고 컬럼</label>
        <select id="invm-warehouse-col" style="width:100%; padding:6px 8px; margin-top:4px; margin-bottom:12px;">
          <option value="">(먼저 테이블을 선택하세요)</option>
        </select>

        <label style="display:block; margin-top:8px; font-weight:600;">재고(수량) 컬럼</label>
        <select id="invm-qty-col" style="width:100%; padding:6px 8px; margin-top:4px; margin-bottom:12px;">
          <option value="">(먼저 테이블을 선택하세요)</option>
        </select>

        <div style="display:flex; justify-content:flex-end; gap:.5rem; margin-top:6px;">
          <button id="inv-modal-run" type="button" class="pp-btn primary">적용</button>
          <button id="inv-modal-close" type="button" class="pp-btn">닫기</button>
        </div>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>